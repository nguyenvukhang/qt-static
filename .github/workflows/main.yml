name: release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+**"

permissions:
  contents: write

env:
  QT_SRC_DIR: qt_src
  QT_OUTPUT_DIR: qt_output
  QT_VERSION: 6.4.2

jobs:
  mac:
    name: Mac
    runs-on: macos-latest
    steps:
      - run: |
          echo "ASSET=qt-static-${{ runner.os }}-${{ env.QT_VERSION }}.tar.gz">>$GITHUB_ENV
      - uses: actions/checkout@v3
      - run: brew install ninja

      - uses: actions/cache@v3
        with:
          key: ${{ runner.os }}-qt
          path: ${{ env.QT_OUTPUT_DIR }} ${{ env.QT_SRC_DIR }}

      - run: mkdir ${{ env.QT_SRC_DIR }} && mkdir ${{ env.QT_OUTPUT_DIR }}

      - run: |
          git clone https://code.qt.io/qt/qt5.git \
          -b v${{ env.QT_VERSION }} ${{ env.QT_SRC_DIR }}

      - run: |
          cd ${{ env.QT_SRC_DIR }}
          ./init-repository -f --module-subset=qtbase

      - run: |
          cd ${{ env.QT_SRC_DIR }}
          ./configure -opensource -release -static \
            -nomake examples \
            -skip qt3d \
            -skip qt5compat \
            -skip qtactiveqt \
            -skip qtcharts \
            -skip qtcoap \
            -skip qtconnectivity \
            -skip qtdatavis3d \
            -skip qtdeclarative \
            -skip qtdoc \
            -skip qthttpserver \
            -skip qtlanguageserver \
            -skip qtlottie \
            -skip qtmqtt \
            -skip qtmultimedia \
            -skip qtnetworkauth \
            -skip qtopcua \
            -skip qtpositioning \
            -skip qtquick3d \
            -skip qtquick3dphysics \
            -skip qtquicktimeline \
            -skip qtremoteobjects \
            -skip qtscxml \
            -skip qtsensors \
            -skip qtserialbus \
            -skip qtserialport \
            -skip qtshadertools \
            -skip qtspeech \
            -skip qtsvg \
            -skip qttools \
            -skip qtwebsockets

      - run: |
          cd ${{ env.QT_SRC_DIR }}
          ninja -j6

      - run: |
          cd ${{ env.QT_SRC_DIR }}
          ninja install

      - run: tar -zcvf ${{ env.ASSET }} ${{ env.QT_OUTPUT_DIR }}

      - uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ASSET }}
          generate_release_notes: true
