name: release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+**"

permissions:
  contents: write

env:
  QT_OUTPUT_DIR_NAME: qt_output
  QT_SRC_DIR_NAME: qt_src
  QT_VERSION: 6.4.2

jobs:
  mac:
    name: Mac
    strategy:
      matrix:
        os: [macos-11, macos-12]
    runs-on: ${{ matrix.os }}
    fail-fast: false
    steps:
      - name: set environment variables
        run: |
          echo "QT_SRC_DIR=${{ github.workspace }}/${{ env.QT_SRC_DIR_NAME }}">>$GITHUB_ENV
          echo "QT_OUTPUT_DIR=${{ github.workspace }}/${{ env.QT_OUTPUT_DIR_NAME }}">>$GITHUB_ENV
          echo "ASSET=qt-${{ env.QT_VERSION }}:${{ matrix.os }}.tar.gz">>$GITHUB_ENV

      - uses: actions/checkout@v3
      - run: brew install ninja

      - run: |
          git clone https://code.qt.io/qt/qt5.git \
          -b v${{ env.QT_VERSION }} ${{ env.QT_SRC_DIR }}

      - working-directory: ${{ env.QT_SRC_DIR }}
        run: ./init-repository -f --module-subset=qtbase

      - working-directory: ${{ env.QT_SRC_DIR }}
        run: ./configure -prefix ${{ env.QT_OUTPUT_DIR }} \
            -opensource -release -static \
            -nomake examples \
            -skip qt3d \
            -skip qt5compat \
            -skip qtactiveqt \
            -skip qtcharts \
            -skip qtcoap \
            -skip qtconnectivity \
            -skip qtdatavis3d \
            -skip qtdeclarative \
            -skip qtdoc \
            -skip qthttpserver \
            -skip qtlanguageserver \
            -skip qtlottie \
            -skip qtmqtt \
            -skip qtmultimedia \
            -skip qtnetworkauth \
            -skip qtopcua \
            -skip qtpositioning \
            -skip qtquick3d \
            -skip qtquick3dphysics \
            -skip qtquicktimeline \
            -skip qtremoteobjects \
            -skip qtscxml \
            -skip qtsensors \
            -skip qtserialbus \
            -skip qtserialport \
            -skip qtshadertools \
            -skip qtspeech \
            -skip qtsvg \
            -skip qttools \
            -skip qtwebsockets

      - working-directory: ${{ env.QT_SRC_DIR }}
        run: ninja -j6

      - working-directory: ${{ env.QT_SRC_DIR }}
        run: ninja install

      - working-directory: ${{ env.QT_OUTPUT_DIR }}/..
        run: tar -zcvf ${{ env.ASSET }} ${{ env.QT_OUTPUT_DIR_NAME }}

      - uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ASSET }}
          generate_release_notes: true
